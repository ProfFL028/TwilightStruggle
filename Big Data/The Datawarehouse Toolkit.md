# The Datawarehouse Toolkit

## 一、数据仓库、商业智能及维度建模初步
生产环境的数据库往往用于数据获取，而数据仓库等的主要作用在于数据使用。两个场景的区别使得数据结构的设计有本质的区别。  
主要用于数据获取的数据库，表结构设计时应尽量满足3NF范式(all the attributes are functionally dependent on solely the primary key)，减少数据的冗余。  
主要用于数据使用的数据库，表结构的设计时应尽量详细地描述一个事实，或者一个维度，往往不满足3NF范式。  
数据仓库、商业智能的目标：  
1. 方便地读取信息
2. 以一致的形式展现信息
3. 适应变化
4. 提高决策的制定能力
5. 以商业用户理解的方式发布数据
6. 提供高效的查询性能
7. 保护信息财富的安全堡垒

## 二、维度建模概述
### 理解业务需求是开始维度建模前非常重要的工作，主要回答四个问题：
1. 关键性能指标
2. 竞争性商业问题
3. 决策制定过程
4. 支持分析需求的目的  

### 维度建模的过程：
1. 业务过程
2. 声明粒度
3. 确认维度。维度是用于过滤和分类事实的描述性属性。比如谁、什么、何处、何时、为什么、如何。
4. 确认事实。来自业务过程事件的度量，一般以数量值形式表示。

### 事实表技术基础：
事实表的数字度量可按是否“可加”分成可加、半可加、不可加事实。半可加事实比如差额，不可加事实比如比率。通常在DW层时，尽量使用可加事实，将半可加、不可加事实转换成可加事实。在BI层时，根据业务（分析）需要转换为半可加、不可加事实。  
事实表可以存储空值，但外键不能有空值，可以使用默认值或表示未知的值代替。  
多个事实表中的值应保持一致性。一是名称一致性，两个事实是兼容的，名称应该一致。反之，如果两个事实不兼容，名称应该不同。二是多个事实表的计算度量应该是一致的。  
事实表的分类：  
* 事务事实表：一行对应空间或时间上某点的度量事件。
* 周期快照事实表：汇总发生在某一标准周期的多个度量事件。
* 累积快照事实表：汇总发生在一个过程的开始到结束之间可预测步骤内的度量事件。
* 无事实的事实表：实际发生的事件的活动表。（客户交际表、学生参加课程表）
* 聚集事实表：对原子粒度事实表数据进行简单的数字化上卷操作，目的是提高查询性能。
* 合并事实表：将多个以相同粒度表示的过程事实表并合为一张事实表。

### 维度表技术基础：
维度表的一些表结构：  
* 主键：维度表需包含单一的主键列。选择自然键（源系统的主键）做主键，可能会遇到兼容性的问题。可以用从1开始自增的自然数做主键。遇到员工离职又重新入职的情况，通常我们不希望此员工有两个主键，此时需要我们将这种主键变成持久性超自然键。
* 下钻：增加一个行头指针，指向一个维度属性，附加了SQL的group by 表达式。
* 退化维度：看起来像事实表的一个维度的关键字。比如发票维度，可以把发票维度表的内容全部归集在事实表中，这样发票维度表可以只有发票号一个字段。这样做的好处是简单，便于查询。
* 非规范化扁平维度：设计时不满足3NF的要求，但可以简化查询，同时提高查询的速度。
* 多层次维度： 年月日层次，地理层次等。
* 文档属性的标识与指示器： 码表。
* 空值：空值用空字符串或代表未知的值替换。
* 日历日期维度： 按熟悉的日期、月份、财务周期、节假日等。如果需要更精确的度，可以添加工作时间等等字段。
* 扮演角色的维度： 一个事实表引用同一维度表多次，不同的维度视图被称为角色。
* 杂项维度: 一系列混杂的、低粒度的标识和指示器。（数据字典）
* 雪花维度、支架维度：应在设计时尽量减少表间的关联，降低查询的难度。

### 处理缓慢变化维度属性
* 原样保留：维度属性值不会发生变化，事实表以原始值分组。
* 重写： 维度行中原来的属性值会被新值覆盖。 在使用时需小心事实表是否会受此影响。
* 增加新行： 在维度表中增加新行，新行采用修改的属性值。一般需要三个额外列：行有效时间戳；行截止时间戳；当前行标识。
* 增加新属性： 在维度表中增加新属性以保存原来的属性。
* 增加微型维度： 当一个维度表快速变化时，可以新增一张微型维度表。此微型维度表中从原维度中提取部分不经常变化的属性做成一张维度表。这里面的微型维度表应是事实表中的外键的一部分，这样就不需要先关联维度表，直接关联此微型表即可。例如年龄字段，可以切割成18周岁以下，30周岁以下，45周岁以下，60周岁以下，60周岁以上。这样维度表就不会经常变化，也方便我们查询。
* 微型维度组成的重写维度: 微型维度表是维度表的外键而不是事实表的外键，方便筛选原维度成员。
* 囊括原样保留、重写、增加新行的微型维度：产品表：  

| 产品主键 | 产品名称 | 产品描述 | 历史部门 | 当前部门 | 其他数据 | 生效时间 | 截止时间 | 数据状态 |
| ------- | -------- |---------| --------|----------|---------|---------|---------|----------|
| 1       |  打印机  | 多功能打印机| 财务部| 公司部    | 。。。。| 2020-01-01|2020-03-31| Expired|
| 2       |  打印机  | 多功能打印机| 销售部| 公司部    | 。。。。| 2020-04-01|2020-10-31| Expired|
| 3       |  打印机  | 多功能打印机| 公司部| 公司部    | 。。。。| 2020-10-31|9999-12-31| Current|

产品所属部门更新时，同样会更新历史库中的“当前部门”字段。
* 双重外键：在事实表中关键维度表的自然键。只需要一次查询即可实现。

## 三、